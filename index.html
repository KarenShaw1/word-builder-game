<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NZ Word Builder Game</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Tone.js for sound effects -->
    <script src="https://unpkg.com/tone@14.8.49/build/Tone.js"></script>
    <style>
        /* Import Comfortaa Font and apply it globally */
        @import url('https://fonts.googleapis.com/css2?family=Comfortaa:wght@400;700&display=swap');
        body, * {
            font-family: 'Comfortaa', cursive;
        }
        
        /* Custom Styles for Dragging Elements */
        .draggable-tile {
            cursor: grab;
            transition: transform 0.1s ease-in-out, opacity 0.3s;
        }
        .draggable-tile:active {
            cursor: grabbing;
        }

        /* Styling for the drop zones */
        .drop-zone {
            transition: background-color 0.2s;
            border: 2px dashed #90a4ae;
        }
        .drop-zone.hover {
            background-color: #f7e2c9; /* Light amber highlight */
        }

        /* --- Success/Failure Visual Effects --- */
        
        /* General bounce animation for text feedback */
        .feedback-correct {
            animation: bounce-in 0.5s;
        }
        .feedback-incorrect {
            animation: shake 0.5s;
        }
        
        @keyframes bounce-in {
            0% { transform: scale(0.5); opacity: 0; }
            70% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }
        
        /* Pulse/Glow effect for the image container on correct answer */
        .success-pulse {
            /* Uses Emerald Green (Tailwind 500 equivalent) */
            animation: success-pulse-keyframe 0.6s ease-out forwards; 
        }

        @keyframes success-pulse-keyframe {
            0% { 
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); 
                transform: scale(1); 
                border-color: #34d399; /* Light green border */
            } 
            50% { 
                box-shadow: 0 0 30px 15px rgba(16, 185, 129, 0.8); 
                transform: scale(1.05); 
                border-color: #10b981; /* Darker green border */
            }
            100% { 
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); 
                transform: scale(1); 
                border-color: #10b981; 
            }
        }
        
        /* Ensure the layout is responsive and centered */
        .game-container {
            max-width: 90%;
            min-height: 80vh;
        }
    </style>
</head>
<body class="bg-indigo-50 min-h-screen flex justify-center items-center p-4">

    <!-- Game Container: Changed to bg-amber-100 for a brighter, warm tone -->
    <div id="game-container" class="game-container bg-amber-100 shadow-2xl rounded-2xl p-6 md:p-10 w-full max-w-xl flex flex-col items-center">

        <!-- Header -->
        <header class="text-center mb-6 w-full">
            <h1 class="text-4xl font-extrabold text-indigo-700">
                Word Builder Challenge!
            </h1>
            <p class="text-lg text-gray-500 mt-2">
                Drag the sounds to spell the word (NZ Year 2 Phonics)
            </p>
        </header>
        
        <!-- Score Counter -->
        <div id="score-counter" class="w-full flex justify-around text-xl font-bold mt-2 mb-6 p-3 rounded-xl bg-amber-200 shadow-md">
            <span class="text-green-700">✅ Correct: <span id="correct-count">0</span></span>
            <span class="text-red-700">❌ Wrong: <span id="incorrect-count">0</span></span>
        </div>

        <!-- Picture & Slots Area -->
        <main class="w-full flex flex-col items-center space-y-6 mb-8">
            
            <!-- Picture Area -->
            <div id="word-image-container" class="w-40 h-40 md:w-48 md:h-48 rounded-full shadow-xl border-4 border-indigo-300 overflow-hidden relative mb-4 flex items-center justify-center bg-gray-100">
                <!-- Image will be loaded here -->
            </div>
            
            <!-- Drop Zone Slots -->
            <div id="drop-slots-container" class="flex justify-center flex-wrap gap-2 md:gap-4 p-2 bg-amber-50 rounded-lg shadow-inner w-full">
                <!-- Drop zones will be rendered here -->
            </div>
            
            <!-- Feedback Message -->
            <div id="feedback-message" class="h-10 text-xl font-bold mt-4"></div>

            <!-- Buttons -->
            <div id="button-area" class="flex space-x-4 mt-6">
                <button id="check-button" onclick="checkWord()" disabled class="px-6 py-3 bg-green-500 text-white font-bold rounded-xl shadow-lg hover:bg-green-600 transition duration-150 disabled:opacity-50">
                    Check
                </button>
                <button id="next-button" onclick="loadNextWord()" disabled class="px-6 py-3 bg-indigo-500 text-white font-bold rounded-xl shadow-lg hover:bg-indigo-600 transition duration-150 disabled:opacity-50">
                    Next Word
                </button>
            </div>
        </main>

        <!-- Draggable Tiles Area -->
        <section class="w-full text-center p-4 bg-yellow-100 rounded-xl border-4 border-yellow-400 shadow-md mt-6">
            <h2 class="text-2xl font-bold text-yellow-800 mb-4">
                Available Sounds
            </h2>
            <div id="tiles-container" class="flex flex-wrap justify-center gap-3 md:gap-4 min-h-[100px]">
                <!-- Draggable tiles will be rendered here -->
            </div>
        </section>

    </div>

    <script>
        // --- Tone.js Audio Setup ---
        let synth; 

        function initializeAudio() {
             // Initialize a polyphonic synth for a richer sound
            synth = new Tone.PolySynth(Tone.Synth, {
                oscillator: { type: "square" },
                envelope: {
                    attack: 0.02,
                    decay: 0.1,
                    sustain: 0.1,
                    release: 0.5
                }
            }).toDestination();
        }

        function playCorrectSound() {
            // Play a short, cheerful C Major chord (C5, E5, G5)
            const now = Tone.now();
            synth.triggerAttackRelease(["C5", "E5", "G5"], "8n", now);
        }

        function playIncorrectSound() {
            // Play a dissonant, short sound (D3, C#3)
            const now = Tone.now();
            synth.triggerAttackRelease(["D3", "C#3"], "16n", now);
        }

        // --- Game Data (Sounds are all lowercase) ---
        const wordData = [
            { word: "HAT", sounds: ["h", "a", "t"], color: "f97316", fontColor: "ffffff", bgColor: "orange-50" }, 
            { word: "FROG", sounds: ["f", "r", "o", "g"], color: "22c55e", fontColor: "ffffff", bgColor: "lime-50" }, 
            { word: "FISH", sounds: ["f", "i", "sh"], color: "ec4899", fontColor: "ffffff", bgColor: "pink-50" }, 
            { word: "DUCK", sounds: ["d", "u", "ck"], color: "fcd34d", fontColor: "000000", bgColor: "yellow-50" },
            { word: "DOG", sounds: ["d", "o", "g"], color: "ef4444", fontColor: "ffffff", bgColor: "red-50" }, 
            { word: "SHIP", sounds: ["sh", "i", "p"], color: "0ea5e9", fontColor: "ffffff", bgColor: "sky-50" },
            { word: "LAMP", sounds: ["l", "a", "m", "p"], color: "6366f1", fontColor: "ffffff", bgColor: "indigo-50" }, 
            { word: "SUN", sounds: ["s", "u", "n"], color: "f97316", fontColor: "ffffff", bgColor: "yellow-50" },
            { word: "BELL", sounds: ["b", "e", "ll"], color: "be185d", fontColor: "ffffff", bgColor: "rose-50" },
            { word: "TENT", sounds: ["t", "e", "n", "t"], color: "14b8a6", fontColor: "ffffff", bgColor: "teal-50" },
            { word: "RING", sounds: ["r", "i", "ng"], color: "a855f7", fontColor: "ffffff", bgColor: "violet-50" },
            { word: "CHIP", sounds: ["ch", "i", "p"], color: "065f46", fontColor: "ffffff", bgColor: "teal-50" },
            { word: "STAR", sounds: ["st", "ar"], color: "facc15", fontColor: "000000", bgColor: "yellow-50" },
            { word: "TREE", sounds: ["t", "r", "ee"], color: "065f46", fontColor: "ffffff", bgColor: "emerald-50" },
            { word: "CLOUD", sounds: ["cl", "ou", "d"], color: "60a5fa", fontColor: "ffffff", bgColor: "blue-50" },
        ];
        
        // --- SVG Definitions (remain the same, keyed by uppercase word) ---
        const wordSVGs = {
            "HAT": `<svg viewBox="0 0 100 100" class="w-full h-full p-4" xmlns="http://www.w3.org/2000/svg"><rect x="15" y="70" width="70" height="15" rx="5" fill="#facc15"/><path d="M 25 70 L 75 70 L 65 30 L 35 30 Z" fill="#b91c1c"/><path d="M 35 30 Q 50 20 65 30" fill="none" stroke="#991b1b" stroke-width="3" stroke-linecap="round"/></svg>`,
            "FROG": `<svg viewBox="0 0 100 100" class="w-full h-full p-4" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="40" fill="#84cc16"/><circle cx="35" cy="25" r="12" fill="white" stroke="#65a30d" stroke-width="2"/><circle cx="65" cy="25" r="12" fill="white" stroke="#65a30d" stroke-width="2"/><circle cx="35" cy="25" r="4" fill="black"/><circle cx="65" cy="25" r="4" fill="black"/><path d="M 30 65 Q 50 80, 70 65" stroke="black" fill="none" stroke-width="3" stroke-linecap="round"/></svg>`,
            "FISH": `<svg viewBox="0 0 100 100" class="w-full h-full p-4" xmlns="http://www.w3.org/2000/svg"><path d="M 20 50 C 30 20, 70 20, 80 50 C 70 80, 30 80, 20 50 Z" fill="#06b6d4"/><path d="M 80 50 L 90 40 L 90 60 Z" fill="#06b6d4"/><circle cx="35" cy="45" r="5" fill="white"/><circle cx="37" cy="47" r="2" fill="black"/><path d="M 45 40 Q 55 35 60 40" stroke="#0e7490" fill="none" stroke-width="2"/></svg>`,
            "DUCK": `<svg viewBox="0 0 100 100" class="w-full h-full p-4" xmlns="http://www.w3.org/2000/svg"><circle cx="65" cy="65" r="25" fill="#fcd34d"/><circle cx="40" cy="40" r="20" fill="#fcd34d"/><path d="M 50 45 L 60 55 L 50 65 Z" fill="#f59e0b"/><circle cx="35" cy="35" r="3" fill="black"/></svg>`,
            "DOG": `<svg viewBox="0 0 100 100" class="w-full h-full p-4" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="55" r="35" fill="#92400e"/><path d="M 30 20 L 20 40 L 35 45 Z" fill="#78350f"/><path d="M 70 20 L 80 40 L 65 45 Z" fill="#78350f"/><circle cx="40" cy="50" r="3" fill="white"/><circle cx="60" cy="50" r="3" fill="white"/><circle cx="50" cy="65" r="5" fill="black"/></svg>`,
            "SHIP": `<svg viewBox="0 0 100 100" class="w-full h-full p-4" xmlns="http://www.w3.org/2000/svg"><path d="M 10 75 L 90 75 L 80 85 L 20 85 Z" fill="#78350f"/><rect x="48" y="25" width="4" height="50" fill="#a1a1aa"/><polygon points="52,25 75,45 52,65" fill="#fef3c7" stroke="#eab308" stroke-width="1"/></svg>`,
            "LAMP": `<svg viewBox="0 0 100 100" class="w-full h-full p-4" xmlns="http://www.w3.org/2000/svg"><rect x="40" y="80" width="20" height="5" fill="#78350f"/><rect x="48" y="30" width="4" height="50" fill="#a1a1aa"/><path d="M 30 30 L 70 30 L 60 15 L 40 15 Z" fill="#fcd34d"/><circle cx="50" cy="55" r="10" fill="white" opacity="0.8"/></svg>`,
            "SUN": `<svg viewBox="0 0 100 100" class="w-full h-full p-4" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="30" fill="#f59e0b"/><rect x="45" y="5" width="10" height="15" fill="#f59e0b" transform="rotate(0, 50, 50)"/><rect x="45" y="5" width="10" height="15" fill="#f59e0b" transform="rotate(45, 50, 50)"/><rect x="45" y="5" width="10" height="15" fill="#f59e0b" transform="rotate(90, 50, 50)"/><rect x="45" y="5" width="10" height="15" fill="#f59e0b" transform="rotate(135, 50, 50)"/><rect x="45" y="5" width="10" height="15" fill="#f59e0b" transform="rotate(180, 50, 50)"/><rect x="45" y="5" width="10" height="15" fill="#f59e0b" transform="rotate(225, 50, 50)"/><rect x="45" y="5" width="10" height="15" fill="#f59e0b" transform="rotate(270, 50, 50)"/><rect x="45" y="5" width="10" height="15" fill="#f59e0b" transform="rotate(315, 50, 50)"/></svg>`,
            "BELL": `<svg viewBox="0 0 100 100" class="w-full h-full p-4" xmlns="http://www.w3.org/2000/svg"><path d="M 25 25 Q 20 40, 20 60 C 20 80, 80 80, 80 60 Q 80 40, 75 25 Z" fill="#fcd34d" stroke="#f59e0b" stroke-width="3"/><circle cx="50" cy="20" r="5" fill="#f59e0b"/><rect x="48" y="65" width="4" height="10" fill="#a1a1aa"/><circle cx="50" cy="75" r="5" fill="#a1a1aa"/></svg>`,
            "TENT": `<svg viewBox="0 0 100 100" class="w-full h-full p-4" xmlns="http://www.w3.org/2000/svg"><polygon points="50,15 15,85 85,85" fill="#10b981"/><path d="M 50 15 L 50 85" stroke="#059669" stroke-width="3"/><polygon points="50,85 35,50 65,50" fill="#ffffff" stroke="#059669" stroke-width="2"/></svg>`,
            "RING": `<svg viewBox="0 0 100 100" class="w-full h-full p-4" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="30" fill="none" stroke="#a855f7" stroke-width="8"/><circle cx="50" cy="50" r="15" fill="none" stroke="#a855f7" stroke-width="8"/><circle cx="50" cy="50" r="5" fill="#facc15"/></svg>`,
            "CHIP": `<svg viewBox="0 0 100 100" class="w-full h-full p-4" xmlns="http://www.w3.org/2000/svg"><rect x="25" y="15" width="50" height="70" rx="8" fill="#facc15" stroke="#f59e0b" stroke-width="2"/><rect x="30" y="20" width="40" height="60" rx="5" fill="#fef3c7"/></svg>`,
            "STAR": `<svg viewBox="0 0 100 100" class="w-full h-full p-4" xmlns="http://www.w3.org/2000/svg"><polygon points="50,5 65,35 95,35 70,55 80,85 50,65 20,85 30,55 5,35 35,35" fill="#fde047"/></svg>`,
            "TREE": `<svg viewBox="0 0 100 100" class="w-full h-full p-4" xmlns="http://www.w3.org/2000/svg"><rect x="45" y="65" width="10" height="20" fill="#78350f"/><path d="M 50 10 Q 20 20 20 55 C 20 70, 80 70, 80 55 Q 80 20 50 10 Z" fill="#10b981"/></svg>`,
            "CLOUD": `<svg viewBox="0 0 100 100" class="w-full h-full p-4" xmlns="http://www.w3.org/2000/svg"><path d="M 20 60 C 20 40, 40 30, 50 30 S 80 40, 80 60 H 20 Z" fill="#93c5fd" stroke="#60a5fa" stroke-width="2"/><circle cx="30" cy="50" r="15" fill="#93c5fd" stroke="#60a5fa" stroke-width="2"/><circle cx="70" cy="50" r="15" fill="#93c5fd" stroke="#60a5fa" stroke-width="2"/></svg>`,
        };


        // --- Game State & Score Counter ---
        let currentWordIndex = 0;
        let currentWord = {};
        let placedTiles = [];
        let correctCount = 0; 
        let incorrectCount = 0; 

        // --- DOM Elements ---
        const imageContainer = document.getElementById('word-image-container');
        const slotsContainer = document.getElementById('drop-slots-container');
        const tilesContainer = document.getElementById('tiles-container');
        const feedbackMessage = document.getElementById('feedback-message');
        const checkButton = document.getElementById('check-button');
        const nextButton = document.getElementById('next-button');

        // --- Utility Functions ---

        // Simple Fisher-Yates shuffle
        const shuffleArray = (array) => {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        };
        
        // --- Drag and Drop Handlers (FIXED) ---
        
        function handleDragStart(e) {
            e.dataTransfer.setData('text/plain', e.target.dataset.value);
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('sourceId', e.target.id);
            setTimeout(() => e.target.classList.add('opacity-40'), 0);
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            if (e.target.classList.contains('drop-zone') && e.target.children.length === 0) {
                e.target.classList.add('hover');
            }
        }
        
        function handleDragLeave(e) {
            if (e.target.classList.contains('drop-zone')) {
                e.target.classList.remove('hover');
            }
        }

        function handleDrop(e) {
            e.preventDefault();
            
            const soundValue = e.dataTransfer.getData('text/plain');
            const sourceId = e.dataTransfer.getData('sourceId');
            const draggedTile = document.getElementById(sourceId);

            if (!draggedTile) return;

            const dropTargetSlot = e.target.closest('.drop-zone');
            const dropOnPool = e.target.closest('#tiles-container');

            if (dropTargetSlot) {
                // --- 1. Dropping onto a Slot ---
                dropTargetSlot.classList.remove('hover');

                if (dropTargetSlot.children.length === 0) {
                    // 1a. Slot Drop: Place tile into an empty drop zone
                    
                    // Clear the tile's previous slot state if it came from one
                    if (draggedTile.parentNode.classList.contains('drop-zone')) {
                        const oldIndex = Array.from(slotsContainer.children).indexOf(draggedTile.parentNode);
                        placedTiles[oldIndex] = null;
                    } else if (draggedTile.parentNode.id === 'tiles-container') {
                        // If it came from the pool, nothing to clear in placedTiles
                    }
                    
                    dropTargetSlot.appendChild(draggedTile);

                    const newIndex = Array.from(slotsContainer.children).indexOf(dropTargetSlot);
                    placedTiles[newIndex] = soundValue;

                } else {
                    // 1b. Slot Swap: Swapping tiles
                    const existingTile = dropTargetSlot.firstElementChild;
                    const oldParent = draggedTile.parentNode;
                    
                    if (oldParent.id === 'tiles-container') {
                        // Tile came from pool, existing tile goes back to pool
                        oldParent.appendChild(existingTile); 
                        dropTargetSlot.appendChild(draggedTile); 
                        
                        // Update only the new slot index as the old tile went back to the unsorted pool
                        const newIndex = Array.from(slotsContainer.children).indexOf(dropTargetSlot);
                        placedTiles[newIndex] = draggedTile.dataset.value;
                    } else {
                        // Tile came from another slot (standard slot-slot swap)
                        oldParent.appendChild(existingTile);
                        dropTargetSlot.appendChild(draggedTile);
                        
                        const newIndex = Array.from(slotsContainer.children).indexOf(dropTargetSlot);
                        const oldIndex = Array.from(slotsContainer.children).indexOf(oldParent);
                        
                        placedTiles[newIndex] = draggedTile.dataset.value;
                        placedTiles[oldIndex] = existingTile.dataset.value;
                    }
                }
            } else if (dropOnPool) {
                // --- 2. Dropping back onto the Pool (tiles-container or a tile inside it) ---
                
                // If it came from a slot, clear that slot's value
                const parentSlot = draggedTile.parentNode;
                if (parentSlot && parentSlot.classList.contains('drop-zone')) {
                    const slotIndex = Array.from(slotsContainer.children).indexOf(parentSlot);
                    placedTiles[slotIndex] = null;
                }
                
                // Append it back to the tiles container (this places it at the end of the list)
                tilesContainer.appendChild(draggedTile);
            }

            // Finish drag operation regardless of success
            draggedTile.classList.remove('opacity-40');
            updateCheckButtonState();
        }
        
        function updateCheckButtonState() {
            // Check if all slots have a tile
            const allSlotsFilled = placedTiles.every(tile => tile !== null);
            checkButton.disabled = !allSlotsFilled;
        }

        function updateScoreDisplay() {
            document.getElementById('correct-count').textContent = correctCount;
            document.getElementById('incorrect-count').textContent = incorrectCount;
        }

        // --- Render Functions ---

        function renderImage(data) {
            imageContainer.innerHTML = '';
            imageContainer.className = 'w-40 h-40 md:w-48 md:h-48 rounded-full shadow-xl border-4 border-indigo-300 overflow-hidden relative mb-4 flex items-center justify-center';
            
            const svgContent = wordSVGs[data.word];

            if (svgContent) {
                imageContainer.innerHTML = svgContent;
                imageContainer.classList.add(`bg-${data.bgColor}`); 
            } else {
                const url = `https://placehold.co/192x192/94a3b8/000000?text=${data.word}`;
                imageContainer.innerHTML = `
                    <img src="${url}" alt="Picture of a ${data.word}" class="w-full h-full object-cover p-2 transition duration-500 ease-in-out" 
                         onerror="this.onerror=null; this.src='${url}';" />
                `;
                imageContainer.classList.add('bg-gray-100');
            }
        }

        function renderDropSlots(data) {
            slotsContainer.innerHTML = '';
            placedTiles = Array(data.sounds.length).fill(null);
            data.sounds.forEach((sound, index) => {
                const slot = document.createElement('div');
                slot.className = 'drop-zone empty-box w-20 h-20 md:w-24 md:h-24 bg-white rounded-lg transition duration-150';
                slot.dataset.index = index;
                slot.addEventListener('dragover', handleDragOver);
                slot.addEventListener('dragleave', handleDragLeave);
                slot.addEventListener('drop', handleDrop);
                slotsContainer.appendChild(slot);
            });
        }

        function renderDraggableTiles(data) {
            tilesContainer.innerHTML = '';
            
            const requiredSounds = Array.from(new Set(data.sounds));
            let availableTiles = requiredSounds.map(sound => ({
                id: `tile-${sound}-${Math.random().toString(36).substring(2, 9)}`,
                value: sound,
                isDistractor: false
            }));

            // Common distractors list
            const commonDistractors = ["q", "x", "z", "j", "v", "oo", "ea", "ph", "ie", "au", "ei"]; 
            
            // Filter distractors that are NOT in the required sounds
            let validDistractors = commonDistractors.filter(s => !requiredSounds.includes(s));
            
            // INCREASED: Choose the first 4 available valid distractors
            const chosenDistractors = shuffleArray(validDistractors).slice(0, 4);

            chosenDistractors.forEach((sound, index) => {
                 availableTiles.push({
                    id: `distractor-tile-${sound}-${index}`,
                    value: sound,
                    isDistractor: true
                 });
            });

            // Shuffle the tiles before rendering
            availableTiles = shuffleArray(availableTiles);
            
            // UNIFIED COLOR SCHEME: Indigo to match the app theme 
            const bgColor = 'bg-indigo-100';
            const borderColor = 'border-indigo-400';
            const textColor = 'text-indigo-800';

            availableTiles.forEach(tileData => {
                const tile = document.createElement('div');
                tile.id = tileData.id;
                tile.dataset.value = tileData.value;
                tile.draggable = true;
                
                // Identical class list for all tiles (required and distractors)
                tile.className = `draggable-tile w-20 h-20 md:w-24 md:h-24 ${bgColor} ${borderColor} ${textColor} text-3xl font-bold flex justify-center items-center rounded-xl shadow-md p-1 transition duration-200 hover:scale-105 active:scale-95 border-2`;

                tile.textContent = tileData.value.toUpperCase(); 
                tile.addEventListener('dragstart', handleDragStart);
                tilesContainer.appendChild(tile);
            });
            
            // Attach drop listener to the container itself (FIXED: handleDrop logic now supports dropping on children)
            tilesContainer.addEventListener('drop', handleDrop);
        }
        
        // --- Game Logic ---
        
        function loadWord(index) {
            currentWordIndex = index % wordData.length;
            currentWord = wordData[currentWordIndex];
            
            // Reset UI
            feedbackMessage.textContent = '';
            nextButton.disabled = true;
            checkButton.disabled = true;

            // Render components
            renderImage(currentWord);
            renderDropSlots(currentWord);
            renderDraggableTiles(currentWord);
            
            updateScoreDisplay(); 
        }

        function checkWord() {
            const checkButton = document.getElementById('check-button');
            if (checkButton.disabled) return;

            const isCorrect = currentWord.sounds.every((sound, index) => placedTiles[index] === sound);
            const dropSlots = document.getElementById('drop-slots-container').children;

            if (isCorrect) {
                playCorrectSound();
                
                imageContainer.classList.add('success-pulse');
                
                feedbackMessage.className = 'h-10 text-xl font-bold mt-4 text-green-600 feedback-correct';
                feedbackMessage.textContent = `Tino pai! You spelled ${currentWord.word.toUpperCase()}!`;
                
                Array.from(dropSlots).forEach(slot => {
                    slot.style.borderColor = '#10B981'; // Green-500
                    slot.style.backgroundColor = '#D1FAE5'; // Green-100
                    slot.classList.remove('drop-zone');
                });
                
                checkButton.disabled = true;
                nextButton.disabled = false;
                
                correctCount++; 
            } else {
                playIncorrectSound();

                feedbackMessage.className = 'h-10 text-xl font-bold mt-4 text-red-600 feedback-incorrect';
                feedbackMessage.textContent = 'Oops, try again! Which sound comes first?';
                
                incorrectCount++; 
            }
            
            updateScoreDisplay(); 
        }
        
        function loadNextWord() {
            imageContainer.classList.remove('success-pulse');
            loadWord(currentWordIndex + 1);
        }

        // --- Initialization ---
        window.onload = function() {
            initializeAudio(); 
            loadWord(currentWordIndex);
        };
        
        // --- Global Drag Listeners for body/document to handle tile returns (Fixed and Simplified) ---
        // This handles dropping the tile anywhere outside the designated drop areas (slots or pool container)
        document.addEventListener('dragenter', (e) => e.preventDefault(), false);
        document.addEventListener('dragover', (e) => e.preventDefault(), false);
        document.addEventListener('drop', (e) => {
            const sourceId = e.dataTransfer.getData('sourceId');
            const draggedTile = document.getElementById(sourceId);
            if (!draggedTile) return;

            // If dropped outside the drop-slots AND outside the tiles-container, return it to the pool
            if (!e.target.closest('.drop-zone') && !e.target.closest('#tiles-container')) {
                
                // If it came from a slot, clear that slot's value
                const parentSlot = draggedTile.parentNode;
                if (parentSlot && parentSlot.classList.contains('drop-zone')) {
                    const slotIndex = Array.from(slotsContainer.children).indexOf(parentSlot);
                    placedTiles[slotIndex] = null;
                }

                tilesContainer.appendChild(draggedTile);
                draggedTile.classList.remove('opacity-40');
                
                updateCheckButtonState();
            }
        }, false);

    </script>
</body>
</html>

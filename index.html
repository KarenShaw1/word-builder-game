<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NZ Word Builder Game</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Tone.js for sound effects -->
    <script src="https://unpkg.com/tone@14.8.49/build/Tone.js"></script>
    <style>
        /* Import Comfortaa Font and apply it globally */
        @import url('https://fonts.googleapis.com/css2?family=Comfortaa:wght@400;700&display=swap');
        body, * {
            font-family: 'Comfortaa', cursive;
        }
        
        /* Custom Styles for Dragging Elements */
        .draggable-tile {
            cursor: grab;
            transition: transform 0.1s ease-in-out, opacity 0.3s;
        }
        .draggable-tile:active {
            cursor: grabbing;
        }

        /* Styling for the drop zones */
        .drop-zone {
            transition: background-color 0.2s;
            border: 2px dashed #90a4ae;
        }
        .drop-zone.hover {
            background-color: #ffe0b2; /* Light orange highlight */
        }

        /* --- Success/Failure Visual Effects --- */
        
        /* General bounce animation for text feedback */
        .feedback-correct {
            animation: bounce-in 0.5s;
        }
        .feedback-incorrect {
            animation: shake 0.5s;
        }
        
        @keyframes bounce-in {
            0% { transform: scale(0.5); opacity: 0; }
            70% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }
        
        /* Pulse/Glow effect for the image container on correct answer */
        .success-pulse {
            /* Uses Emerald Green (Tailwind 500 equivalent) */
            animation: success-pulse-keyframe 0.6s ease-out forwards; 
        }

        @keyframes success-pulse-keyframe {
            0% { 
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); 
                transform: scale(1); 
                border-color: #34d399; /* Light green border */
            } 
            50% { 
                box-shadow: 0 0 30px 15px rgba(16, 185, 129, 0.8); 
                transform: scale(1.05); 
                border-color: #10b981; /* Darker green border */
            }
            100% { 
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); 
                transform: scale(1); 
                border-color: #10b981; 
            }
        }
        
        /* Ensure the layout is responsive and centered */
        .game-container {
            max-width: 90%;
            min-height: 80vh;
        }

        /* Style for the results breakdown */
        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #e5e7eb;
        }
    </style>
</head>
<body class="bg-pink-200 min-h-screen flex justify-center items-center p-4">

    <!-- Game Container -->
    <div id="game-container" class="game-container bg-white shadow-2xl rounded-2xl p-6 md:p-10 w-full max-w-xl flex flex-col items-center">

        <!-- Header -->
        <header class="text-center mb-8 w-full">
            <h1 class="text-4xl font-extrabold text-indigo-700">
                Word Builder Challenge!
            </h1>
            <p class="text-lg text-gray-500 mt-2">
                Drag the sounds to spell the word (NZ Year 2 Phonics)
            </p>
        </header>
        
        <!-- Score and Attempts Tracker -->
        <div id="status-bar" class="w-full flex justify-between items-center mb-6 p-3 bg-indigo-100 rounded-lg shadow-md">
            <div class="text-center">
                <span id="current-round-text" class="text-lg font-bold text-indigo-800"></span>
            </div>
            <div class="text-center">
                <p class="text-sm text-gray-600">Correct / Total</p>
                <span class="text-xl font-bold text-green-700"><span id="correct-words-count">0</span> / <span id="total-words-count">0</span></span>
            </div>
            <div class="text-center">
                <p class="text-sm text-gray-600">Tries Left</p>
                <span id="attempts-left-display" class="text-xl font-bold text-red-600">3</span>
            </div>
        </div>


        <!-- Picture & Slots Area (Game Interface) -->
        <main id="main-game-area" class="w-full flex flex-col items-center space-y-6 mb-8">
            
            <!-- Picture Area -->
            <div id="word-image-container" class="w-40 h-40 md:w-48 md:h-48 rounded-full shadow-xl border-4 border-indigo-300 overflow-hidden relative mb-4 flex items-center justify-center bg-gray-100">
                <!-- Image will be loaded here -->
            </div>
            
            <!-- Drop Zone Slots -->
            <div id="drop-slots-container" class="flex justify-center flex-wrap gap-2 md:gap-4 p-2 bg-gray-50 rounded-lg shadow-inner w-full">
                <!-- Drop zones will be rendered here -->
            </div>
            
            <!-- Feedback Message -->
            <div id="feedback-message" class="h-10 text-xl font-bold mt-4"></div>

            <!-- Buttons -->
            <div id="button-area" class="flex space-x-4 mt-6">
                <button id="check-button" onclick="checkWord()" disabled class="px-6 py-3 bg-green-500 text-white font-bold rounded-xl shadow-lg hover:bg-green-600 transition duration-150 disabled:opacity-50">
                    Check
                </button>
                <button id="next-button" onclick="loadNextWord()" disabled class="px-6 py-3 bg-indigo-500 text-white font-bold rounded-xl shadow-lg hover:bg-indigo-600 transition duration-150 disabled:opacity-50">
                    Skip Word
                </button>
            </div>
        </main>

        <!-- Draggable Tiles Area -->
        <section id="tiles-section" class="w-full text-center p-4 bg-yellow-100 rounded-xl border-4 border-yellow-400 shadow-md mt-6">
            <h2 class="text-2xl font-bold text-yellow-800 mb-4">
                Available Sounds
            </h2>
            <div id="tiles-container" class="flex flex-wrap justify-center gap-3 md:gap-4 min-h-[100px]">
                <!-- Draggable tiles will be rendered here -->
            </div>
        </section>

        <!-- Final Results Screen (Hidden) -->
        <div id="results-interface" class="hidden w-full text-center">
             <h2 id="final-message" class="text-4xl font-extrabold mb-4 text-gray-800">Game Over!</h2>
            
            <div class="bg-green-50 p-6 rounded-lg mb-8 shadow-lg">
                <p class="text-2xl text-gray-700 font-semibold mb-2">Final Score:</p>
                <p class="text-6xl font-extrabold text-gray-800 mt-2">
                    <span id="results-correct-count" class="text-green-600">0</span> / <span id="results-total-count">0</span>
                </p>
                <p class="text-xl font-medium text-gray-600 mt-1">Correct Words</p>
            </div>

            <h3 class="text-2xl font-semibold mb-4 text-gray-800 border-b pb-2">Round Breakdown</h3>
            <div id="results-breakdown" class="max-h-96 overflow-y-auto text-left px-4">
                <!-- Detailed results go here -->
            </div>

            <button id="restart-button-results" onclick="setupGame()" class="w-full mt-8 py-3 px-6 bg-indigo-600 text-white font-bold rounded-xl shadow-lg hover:bg-indigo-700 transition duration-300">
                Play Again
            </button>
        </div>

    </div>

    <script>
        // --- Tone.js Audio Setup ---
        let synth; 

        function initializeAudio() {
             // Initialize a polyphonic synth for a richer sound
            synth = new Tone.PolySynth(Tone.Synth, {
                oscillator: { type: "square" },
                envelope: {
                    attack: 0.02,
                    decay: 0.1,
                    sustain: 0.1,
                    release: 0.5
                }
            }).toDestination();
        }

        function playCorrectSound() {
            const now = Tone.now();
            synth.triggerAttackRelease(["C5", "E5", "G5"], "8n", now);
        }

        function playIncorrectSound() {
            const now = Tone.now();
            synth.triggerAttackRelease(["D3", "C#3"], "16n", now);
        }
        
        function playFailSound() {
            // Lower, more somber sound for running out of tries (A2, C3)
            const now = Tone.now();
            synth.triggerAttackRelease(["A2", "C3"], "0.3s", now);
        }

        // --- Game Data (Sounds are all lowercase) ---
        const wordData = [
            { word: "HAT", sounds: ["h", "a", "t"], color: "f97316", fontColor: "ffffff", bgColor: "orange-50" }, 
            { word: "FROG", sounds: ["f", "r", "o", "g"], color: "22c55e", fontColor: "ffffff", bgColor: "lime-50" }, 
            { word: "FISH", sounds: ["f", "i", "sh"], color: "ec4899", fontColor: "ffffff", bgColor: "pink-50" }, 
            { word: "DUCK", sounds: ["d", "u", "ck"], color: "fcd34d", fontColor: "000000", bgColor: "yellow-50" },
            { word: "DOG", sounds: ["d", "o", "g"], color: "ef4444", fontColor: "ffffff", bgColor: "red-50" }, 
            { word: "SHIP", sounds: ["sh", "i", "p"], color: "0ea5e9", fontColor: "ffffff", bgColor: "sky-50" },
            { word: "LAMP", sounds: ["l", "a", "m", "p"], color: "6366f1", fontColor: "ffffff", bgColor: "indigo-50" }, 
            { word: "SUN", sounds: ["s", "u", "n"], color: "f97316", fontColor: "ffffff", bgColor: "yellow-50" },
            { word: "BELL", sounds: ["b", "e", "ll"], color: "be185d", fontColor: "ffffff", bgColor: "rose-50" },
            { word: "TENT", sounds: ["t", "e", "n", "t"], color: "14b8a6", fontColor: "ffffff", bgColor: "teal-50" },
            { word: "RING", sounds: ["r", "i", "ng"], color: "a855f7", fontColor: "ffffff", bgColor: "violet-50" },
            { word: "CHIP", sounds: ["ch", "i", "p"], color: "065f46", fontColor: "ffffff", bgColor: "teal-50" },
            { word: "STAR", sounds: ["st", "ar"], color: "facc15", fontColor: "000000", bgColor: "yellow-50" },
            { word: "TREE", sounds: ["t", "r", "ee"], color: "065f46", fontColor: "ffffff", bgColor: "emerald-50" },
            { word: "CLOUD", sounds: ["cl", "ou", "d"], color: "60a5fa", fontColor: "ffffff", bgColor: "blue-50" },
        ];
        
        // --- SVG Definitions (remain the same, keyed by uppercase word) ---
        const wordSVGs = {
            "HAT": `
                <svg viewBox="0 0 100 100" class="w-full h-full p-4" xmlns="http://www.w3.org/2000/svg">
                    <rect x="15" y="70" width="70" height="15" rx="5" fill="#facc15"/>
                    <path d="M 25 70 L 75 70 L 65 30 L 35 30 Z" fill="#b91c1c"/>
                    <path d="M 35 30 Q 50 20 65 30" fill="none" stroke="#991b1b" stroke-width="3" stroke-linecap="round"/>
                </svg>`,
            "FROG": `
                <svg viewBox="0 0 100 100" class="w-full h-full p-4" xmlns="http://www.w3.org/2000/svg">
                    <!-- Body (Lime Green) -->
                    <circle cx="50" cy="50" r="40" fill="#84cc16"/>
                    <!-- White Eyes on top of body -->
                    <circle cx="35" cy="25" r="12" fill="white" stroke="#65a30d" stroke-width="2"/>
                    <circle cx="65" cy="25" r="12" fill="white" stroke="#65a30d" stroke-width="2"/>
                    <!-- Pupils (Black) -->
                    <circle cx="35" cy="25" r="4" fill="black"/>
                    <circle cx="65" cy="25" r="4" fill="black"/>
                    <!-- Mouth (Smile) -->
                    <path d="M 30 65 Q 50 80, 70 65" stroke="black" fill="none" stroke-width="3" stroke-linecap="round"/>
                </svg>`,
            "FISH": `
                <svg viewBox="0 0 100 100" class="w-full h-full p-4" xmlns="http://www.w3.org/2000/svg">
                    <path d="M 20 50 C 30 20, 70 20, 80 50 C 70 80, 30 80, 20 50 Z" fill="#06b6d4"/>
                    <path d="M 80 50 L 90 40 L 90 60 Z" fill="#06b6d4"/>
                    <circle cx="35" cy="45" r="5" fill="white"/>
                    <circle cx="37" cy="47" r="2" fill="black"/>
                    <path d="M 45 40 Q 55 35 60 40" stroke="#0e7490" fill="none" stroke-width="2"/>
                </svg>`,
            "DUCK": `
                <svg viewBox="0 0 100 100" class="w-full h-full p-4" xmlns="http://www.w3.org/2000/svg">
                    <!-- Body -->
                    <circle cx="65" cy="65" r="25" fill="#fcd34d"/>
                    <!-- Head -->
                    <circle cx="40" cy="40" r="20" fill="#fcd34d"/>
                    <!-- Beak -->
                    <path d="M 50 45 L 60 55 L 50 65 Z" fill="#f59e0b"/>
                    <!-- Eye -->
                    <circle cx="35" cy="35" r="3" fill="black"/>
                </svg>`,
            "DOG": `
                <svg viewBox="0 0 100 100" class="w-full h-full p-4" xmlns="http://www.w3.org/2000/svg">
                    <!-- Head -->
                    <circle cx="50" cy="55" r="35" fill="#92400e"/>
                    <!-- Left Ear -->
                    <path d="M 30 20 L 20 40 L 35 45 Z" fill="#78350f"/>
                    <!-- Right Ear -->
                    <path d="M 70 20 L 80 40 L 65 45 Z" fill="#78350f"/>
                    <!-- Eyes -->
                    <circle cx="40" cy="50" r="3" fill="white"/>
                    <circle cx="60" cy="50" r="3" fill="white"/>
                    <!-- Nose -->
                    <circle cx="50" cy="65" r="5" fill="black"/>
                </svg>`,
            "SHIP": `
                <svg viewBox="0 0 100 100" class="w-full h-full p-4" xmlns="http://www.w3.org/2000/svg">
                    <!-- Hull -->
                    <path d="M 10 75 L 90 75 L 80 85 L 20 85 Z" fill="#78350f"/>
                    <!-- Mast -->
                    <rect x="48" y="25" width="4" height="50" fill="#a1a1aa"/>
                    <!-- Sail -->
                    <polygon points="52,25 75,45 52,65" fill="#fef3c7" stroke="#eab308" stroke-width="1"/>
                </svg>`,
            "LAMP": `
                <svg viewBox="0 0 100 100" class="w-full h-full p-4" xmlns="http://www.w3.org/2000/svg">
                    <!-- Base -->
                    <rect x="40" y="80" width="20" height="5" fill="#78350f"/>
                    <!-- Stand -->
                    <rect x="48" y="30" width="4" height="50" fill="#a1a1aa"/>
                    <!-- Shade -->
                    <path d="M 30 30 L 70 30 L 60 15 L 40 15 Z" fill="#fcd34d"/>
                    <!-- Light glow placeholder -->
                    <circle cx="50" cy="55" r="10" fill="white" opacity="0.8"/>
                </svg>`,
            "SUN": `
                <svg viewBox="0 0 100 100" class="w-full h-full p-4" xmlns="http://www.w3.org/2000/svg">
                    <!-- Center Circle -->
                    <circle cx="50" cy="50" r="30" fill="#f59e0b"/>
                    <!-- Rays -->
                    <rect x="45" y="5" width="10" height="15" fill="#f59e0b" transform="rotate(0, 50, 50)"/>
                    <rect x="45" y="5" width="10" height="15" fill="#f59e0b" transform="rotate(45, 50, 50)"/>
                    <rect x="45" y="5" width="10" height="15" fill="#f59e0b" transform="rotate(90, 50, 50)"/>
                    <rect x="45" y="5" width="10" height="15" fill="#f59e0b" transform="rotate(135, 50, 50)"/>
                    <rect x="45" y="5" width="10" height="15" fill="#f59e0b" transform="rotate(180, 50, 50)"/>
                    <rect x="45" y="5" width="10" height="15" fill="#f59e0b" transform="rotate(225, 50, 50)"/>
                    <rect x="45" y="5" width="10" height="15" fill="#f59e0b" transform="rotate(270, 50, 50)"/>
                    <rect x="45" y="5" width="10" height="15" fill="#f59e0b" transform="rotate(315, 50, 50)"/>
                </svg>`,
            "BELL": `
                <svg viewBox="0 0 100 100" class="w-full h-full p-4" xmlns="http://www.w3.org/2000/svg">
                    <!-- Bell Body -->
                    <path d="M 25 25 Q 20 40, 20 60 C 20 80, 80 80, 80 60 Q 80 40, 75 25 Z" fill="#fcd34d" stroke="#f59e0b" stroke-width="3"/>
                    <!-- Loop -->
                    <circle cx="50" cy="20" r="5" fill="#f59e0b"/>
                    <!-- Clapper Rod -->
                    <rect x="48" y="65" width="4" height="10" fill="#a1a1aa"/>
                    <!-- Clapper Ball -->
                    <circle cx="50" cy="75" r="5" fill="#a1a1aa"/>
                </svg>`,
            "TENT": `
                <svg viewBox="0 0 100 100" class="w-full h-full p-4" xmlns="http://www.w3.org/2000/svg">
                    <!-- Tent Shape -->
                    <polygon points="50,15 15,85 85,85" fill="#10b981"/>
                    <!-- Center Pole/Line -->
                    <path d="M 50 15 L 50 85" stroke="#059669" stroke-width="3"/>
                    <!-- Door Flap -->
                    <polygon points="50,85 35,50 65,50" fill="#ffffff" stroke="#059669" stroke-width="2"/>
                </svg>`,
            "RING": `
                <svg viewBox="0 0 100 100" class="w-full h-full p-4" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="50" cy="50" r="30" fill="none" stroke="#a855f7" stroke-width="8"/>
                    <circle cx="50" cy="50" r="15" fill="none" stroke="#a855f7" stroke-width="8"/>
                    <circle cx="50" cy="50" r="5" fill="#facc15"/>
                </svg>`,
            "CHIP": `
                <svg viewBox="0 0 100 100" class="w-full h-full p-4" xmlns="http://www.w3.org/2000/svg">
                    <!-- Chip shape -->
                    <rect x="25" y="15" width="50" height="70" rx="8" fill="#facc15" stroke="#f59e0b" stroke-width="2"/>
                    <!-- Internal color/texture -->
                    <rect x="30" y="20" width="40" height="60" rx="5" fill="#fef3c7"/>
                </svg>`,
            "STAR": `
                <svg viewBox="0 0 100 100" class="w-full h-full p-4" xmlns="http://www.w3.org/2000/svg">
                    <!-- 5-pointed Star shape -->
                    <polygon points="50,5 65,35 95,35 70,55 80,85 50,65 20,85 30,55 5,35 35,35" fill="#fde047"/>
                </svg>`,
            "TREE": `
                <svg viewBox="0 0 100 100" class="w-full h-full p-4" xmlns="http://www.w3.org/2000/svg">
                    <!-- Trunk -->
                    <rect x="45" y="65" width="10" height="20" fill="#78350f"/>
                    <!-- Leaves (Simple stylized crown) -->
                    <path d="M 50 10 Q 20 20 20 55 C 20 70, 80 70, 80 55 Q 80 20 50 10 Z" fill="#10b981"/>
                </svg>`,
            "CLOUD": `
                <svg viewBox="0 0 100 100" class="w-full h-full p-4" xmlns="http://www.w3.org/2000/svg">
                    <!-- Main cloud body -->
                    <path d="M 20 60 C 20 40, 40 30, 50 30 S 80 40, 80 60 H 20 Z" fill="#93c5fd" stroke="#60a5fa" stroke-width="2"/>
                    <circle cx="30" cy="50" r="15" fill="#93c5fd" stroke="#60a5fa" stroke-width="2"/>
                    <circle cx="70" cy="50" r="15" fill="#93c5fd" stroke="#60a5fa" stroke-width="2"/>
                </svg>`,
        };


        // --- Game State ---
        let gameWords = []; // Shuffled list of words for the current game
        let currentWordIndex = 0;
        let currentWordData = {}; // Data for the current word
        let placedTiles = [];
        
        let totalCorrect = 0;
        let totalIncorrect = 0;
        let attemptsLeft = 3;
        
        let roundResults = []; // Stores { word: "...", status: "correct"/"failed", attempts: 1, finalRack: [] }

        // --- DOM Elements ---
        const imageContainer = document.getElementById('word-image-container');
        const slotsContainer = document.getElementById('drop-slots-container');
        const tilesContainer = document.getElementById('tiles-container');
        const feedbackMessage = document.getElementById('feedback-message');
        const checkButton = document.getElementById('check-button');
        const nextButton = document.getElementById('next-button');

        // Status bar elements
        const currentRoundText = document.getElementById('current-round-text');
        const correctWordsCount = document.getElementById('correct-words-count');
        const totalWordsCount = document.getElementById('total-words-count');
        const attemptsLeftDisplay = document.getElementById('attempts-left-display');
        
        // Results elements
        const mainGameArea = document.getElementById('main-game-area');
        const tilesSection = document.getElementById('tiles-section');
        const resultsInterface = document.getElementById('results-interface');
        const resultsCorrectCount = document.getElementById('results-correct-count');
        const resultsTotalCount = document.getElementById('results-total-count');
        const resultsBreakdown = document.getElementById('results-breakdown');
        const finalMessage = document.getElementById('final-message');


        // --- Utility Functions ---

        // Simple Fisher-Yates shuffle
        const shuffleArray = (array) => {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = array[j], array[i];
            }
            return array;
        };
        
        // Resets the style of the drop slots
        function resetSlotStyles() {
            Array.from(slotsContainer.children).forEach(slot => {
                slot.style.borderColor = '';
                slot.style.backgroundColor = '';
                slot.classList.add('drop-zone');
                slot.classList.remove('transition-all');
            });
        }
        
        // Updates the overall score displayed in the status bar
        function updateScoreDisplay() {
            correctWordsCount.textContent = totalCorrect;
            totalWordsCount.textContent = totalCorrect + totalIncorrect;
            currentRoundText.textContent = `Word ${currentWordIndex + 1} / ${gameWords.length}`;
            attemptsLeftDisplay.textContent = attemptsLeft;
            
            if (attemptsLeft === 1) {
                attemptsLeftDisplay.classList.add('text-yellow-600');
                attemptsLeftDisplay.classList.remove('text-red-600');
            } else if (attemptsLeft === 0) {
                attemptsLeftDisplay.classList.add('text-red-600');
                attemptsLeftDisplay.classList.remove('text-yellow-600');
            } else {
                attemptsLeftDisplay.classList.remove('text-yellow-600', 'text-red-600');
                attemptsLeftDisplay.classList.add('text-red-600');
            }
        }

        // --- Drag and Drop Handlers (Kept the same) ---
        
        function handleDragStart(e) {
            e.dataTransfer.setData('text/plain', e.target.dataset.value);
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('sourceId', e.target.id);
            setTimeout(() => e.target.classList.add('opacity-40'), 0);
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            if (e.target.classList.contains('drop-zone') && e.target.children.length === 0) {
                e.target.classList.add('hover');
            }
        }
        
        function handleDragLeave(e) {
            if (e.target.classList.contains('drop-zone')) {
                e.target.classList.remove('hover');
            }
        }

        function handleDrop(e) {
            e.preventDefault();
            
            const soundValue = e.dataTransfer.getData('text/plain');
            const sourceId = e.dataTransfer.getData('sourceId');
            const draggedTile = document.getElementById(sourceId);
            const dropTarget = e.target.closest('.drop-zone');

            if (!draggedTile) return;

            // 1. Logic for dropping into a slot
            if (dropTarget && dropTarget.children.length === 0) {
                // Determine if tile is coming from another slot or the rack
                const isFromSlot = draggedTile.parentNode.classList.contains('drop-zone');
                
                // If it came from a slot, clear that old slot's value
                if (isFromSlot) {
                    const oldIndex = Array.from(slotsContainer.children).indexOf(draggedTile.parentNode);
                    placedTiles[oldIndex] = null;
                }
                
                // Place tile in new slot
                dropTarget.appendChild(draggedTile);
                draggedTile.classList.remove('opacity-40');
                dropTarget.classList.remove('hover');

                // Update placedTiles array
                const newIndex = Array.from(slotsContainer.children).indexOf(dropTarget);
                placedTiles[newIndex] = soundValue;
                
                updateCheckButtonState();

            // 2. Logic for swapping tiles between slots
            } else if (dropTarget && dropTarget.classList.contains('drop-zone') && dropTarget.children.length > 0) {
                 const existingTile = dropTarget.firstElementChild;
                 const oldParent = draggedTile.parentNode;
                 
                 // Check if swap is necessary (only swap if dragging from tiles container or another slot)
                 if (oldParent.id === 'tiles-container' && !existingTile.classList.contains('draggable-tile')) return; // Cannot drag to replace non-tile
                 
                 // Perform the swap
                 oldParent.appendChild(existingTile);
                 dropTarget.appendChild(draggedTile);
                 
                 // Update placedTiles array after swap
                 const newIndex = Array.from(slotsContainer.children).indexOf(dropTarget);
                 const oldIndex = Array.from(slotsContainer.children).indexOf(oldParent);
                 
                 placedTiles[newIndex] = draggedTile.dataset.value;
                 placedTiles[oldIndex] = existingTile.dataset.value;
                 
            // 3. Logic for dropping back into the source area
            } else if (e.target.id === 'tiles-container' || e.target.closest('#tiles-container')) {
                // If it came from a slot, clear that slot's value
                const parentSlot = draggedTile.parentNode;
                if (parentSlot && parentSlot.classList.contains('drop-zone')) {
                    const slotIndex = Array.from(slotsContainer.children).indexOf(parentSlot);
                    placedTiles[slotIndex] = null;
                }
                
                // Append it back to the tiles container
                tilesContainer.appendChild(draggedTile);
                draggedTile.classList.remove('opacity-40');
                
                updateCheckButtonState();
            }
        }
        
        function updateCheckButtonState() {
            // Check if all slots have a tile
            const allSlotsFilled = placedTiles.every(tile => tile !== null);
            checkButton.disabled = !allSlotsFilled;
        }

        // --- Render Functions (Simplified for clarity) ---

        function renderImage(data) {
            imageContainer.innerHTML = '';
            imageContainer.className = 'w-40 h-40 md:w-48 md:h-48 rounded-full shadow-xl border-4 border-indigo-300 overflow-hidden relative mb-4 flex items-center justify-center';
            
            const svgContent = wordSVGs[data.word];

            if (svgContent) {
                imageContainer.innerHTML = svgContent;
                // Add the specific background color
                const bgClass = `bg-${data.bgColor.replace('-50', '')}-100`; // Use a slightly lighter version for the circle fill
                imageContainer.classList.add(bgClass); 
            } else {
                const url = `https://placehold.co/192x192/94a3b8/000000?text=${data.word}`;
                imageContainer.innerHTML = `<img src="${url}" alt="Picture of a ${data.word}" class="w-full h-full object-cover p-2" onerror="this.onerror=null; this.src='${url}';" />`;
                imageContainer.classList.add('bg-gray-100');
            }
        }

        function renderDropSlots(data) {
            slotsContainer.innerHTML = ''; 
            placedTiles = Array(data.sounds.length).fill(null); 
            data.sounds.forEach((sound, index) => {
                const slot = document.createElement('div');
                // Use relative positioning to allow tiles to be placed in the center
                slot.className = 'drop-zone w-20 h-20 md:w-24 md:h-24 bg-white rounded-lg transition duration-150 relative flex items-center justify-center border-2 border-dashed border-gray-400';
                slot.dataset.index = index;
                slot.addEventListener('dragover', handleDragOver);
                slot.addEventListener('dragleave', handleDragLeave);
                slot.addEventListener('drop', handleDrop);
                slotsContainer.appendChild(slot);
            });
        }

        function renderDraggableTiles(data) {
            tilesContainer.innerHTML = ''; 
            
            const requiredSounds = Array.from(new Set(data.sounds));
            let availableTiles = requiredSounds.map(sound => ({
                id: `tile-${sound}-${Math.random().toString(36).substring(2, 9)}`,
                value: sound
            }));

            const commonDistractors = ["q", "x", "z", "j", "v", "oo", "ea"]; 
            let validDistractors = commonDistractors.filter(s => !requiredSounds.includes(s));
            const chosenDistractors = shuffleArray(validDistractors).slice(0, 2);

            chosenDistractors.forEach((sound, index) => {
                 availableTiles.push({
                    id: `distractor-tile-${sound}-${index}`,
                    value: sound
                 });
            });

            availableTiles = shuffleArray(availableTiles);
            
            const bgColor = 'bg-blue-100';
            const borderColor = 'border-blue-400';
            const textColor = 'text-blue-800';

            availableTiles.forEach(tileData => {
                const tile = document.createElement('div');
                tile.id = tileData.id;
                tile.dataset.value = tileData.value;
                tile.draggable = true;
                
                tile.className = `draggable-tile w-20 h-20 md:w-24 md:h-24 ${bgColor} ${borderColor} ${textColor} text-3xl font-bold flex justify-center items-center rounded-xl shadow-md p-1 transition duration-200 hover:scale-105 active:scale-95 border-2`;

                tile.textContent = tileData.value;
                tile.addEventListener('dragstart', handleDragStart);
                tilesContainer.appendChild(tile);
            });
            // Re-adding the drop listener to the container itself for returning tiles
            tilesContainer.addEventListener('drop', handleDrop); 
        }
        
        // --- Game Logic ---
        
        function setupGame() {
            // Reset main game state
            gameWords = shuffleArray([...wordData]);
            currentWordIndex = 0;
            totalCorrect = 0;
            totalIncorrect = 0;
            roundResults = [];

            // Show game area, hide results
            mainGameArea.classList.remove('hidden');
            tilesSection.classList.remove('hidden');
            resultsInterface.classList.add('hidden');
            
            loadWord();
        }

        function loadWord() {
            // Check if game is finished
            if (currentWordIndex >= gameWords.length) {
                return endGame();
            }

            currentWordData = gameWords[currentWordIndex];
            
            // Reset round state
            attemptsLeft = 3;
            resetSlotStyles();
            
            // Reset UI
            feedbackMessage.textContent = 'Drag and drop the sounds into the correct order!';
            feedbackMessage.className = 'h-10 text-xl font-bold mt-4 text-gray-700';
            nextButton.disabled = false; // Next button is enabled to skip the word
            checkButton.disabled = true;
            imageContainer.classList.remove('success-pulse');

            // Render components
            renderImage(currentWordData);
            renderDropSlots(currentWordData);
            renderDraggableTiles(currentWordData);
            updateScoreDisplay(); // Update round number and attempts
        }

        function checkWord() {
            if (checkButton.disabled) return;

            // Collect the word currently in the slots
            const currentAttempt = placedTiles.filter(t => t !== null);
            if (currentAttempt.length !== currentWordData.sounds.length) {
                feedbackMessage.className = 'h-10 text-xl font-bold mt-4 text-orange-600 feedback-incorrect';
                feedbackMessage.textContent = 'Please fill all the sound slots.';
                return;
            }

            const isCorrect = currentWordData.sounds.every((sound, index) => placedTiles[index] === sound);
            
            if (isCorrect) {
                // --- CORRECT ATTEMPT ---
                playCorrectSound();
                imageContainer.classList.add('success-pulse');
                
                feedbackMessage.className = 'h-10 text-xl font-bold mt-4 text-green-600 feedback-correct';
                feedbackMessage.textContent = `Tino pai! (${currentWordData.word.toUpperCase()})`;
                
                // Visually lock tiles in place with success style
                Array.from(slotsContainer.children).forEach(slot => {
                    slot.style.borderColor = '#10B981';
                    slot.style.backgroundColor = '#D1FAE5';
                    slot.classList.remove('drop-zone');
                });
                
                // Record result and advance
                totalCorrect++;
                roundResults.push({
                    word: currentWordData.word,
                    status: "correct",
                    attempts: 3 - attemptsLeft + 1, // Calculate attempts used
                    finalRack: currentAttempt
                });

                // Disable buttons and automatically advance
                checkButton.disabled = true;
                nextButton.disabled = true;
                
                setTimeout(loadNextWord, 1500); // Advance after 1.5s
                
            } else {
                // --- INCORRECT ATTEMPT ---
                
                attemptsLeft--;
                updateScoreDisplay(); // Update tries left

                if (attemptsLeft === 0) {
                    // --- FAILED ROUND ---
                    playFailSound();
                    
                    feedbackMessage.className = 'h-10 text-xl font-bold mt-4 text-red-600 feedback-incorrect';
                    feedbackMessage.textContent = `Out of tries! The word was ${currentWordData.word.toUpperCase()}.`;
                    
                    // Visually lock slots with a failure style
                    Array.from(slotsContainer.children).forEach(slot => {
                        slot.style.borderColor = '#F87171'; // Red-400
                        slot.style.backgroundColor = '#FEE2E2'; // Red-100
                        slot.classList.remove('drop-zone');
                    });
                    
                    // Record failure
                    totalIncorrect++;
                    roundResults.push({
                        word: currentWordData.word,
                        status: "failed",
                        attempts: 3,
                        finalRack: currentAttempt
                    });

                    // Disable buttons and automatically advance
                    checkButton.disabled = true;
                    nextButton.disabled = true;
                    setTimeout(loadNextWord, 3000); // Wait longer to show answer
                } else {
                    // --- MISTAKE, TRY AGAIN ---
                    playIncorrectSound();
                    
                    feedbackMessage.className = 'h-10 text-xl font-bold mt-4 text-red-600 feedback-incorrect';
                    feedbackMessage.textContent = `Oops, try again! ${attemptsLeft} tries remaining.`;
                }
            }
        }
        
        function loadNextWord() {
            currentWordIndex++;
            loadWord();
        }

        function endGame() {
            // Hide game area, show results interface
            mainGameArea.classList.add('hidden');
            tilesSection.classList.add('hidden');
            resultsInterface.classList.remove('hidden');

            const totalWords = gameWords.length;
            const successRate = totalCorrect / totalWords;
            
            let messageText;
            let emoji;
            let colorClass;
            
            // Define threshold (70% or more words correct)
            if (successRate >= 0.7) {
                messageText = 'Well done! You nailed the challenge! ðŸ¥³';
                emoji = 'ðŸ¥³';
                colorClass = 'text-green-600';
            } else {
                messageText = 'Keep going! Letâ€™s practice those sounds again. ðŸ˜”';
                emoji = 'ðŸ˜”';
                colorClass = 'text-red-600';
            }
            
            // Update the final summary
            finalMessage.className = `text-4xl font-extrabold mb-4 ${colorClass}`;
            finalMessage.innerHTML = `${messageText} ${emoji}`;
            
            resultsCorrectCount.textContent = totalCorrect;
            resultsTotalCount.textContent = totalWords;

            // Display detailed breakdown
            resultsBreakdown.innerHTML = '';
            roundResults.forEach(item => {
                const isCorrect = item.status === 'correct';
                
                const resultDiv = document.createElement('div');
                resultDiv.classList.add('result-item', isCorrect ? 'text-green-800' : 'text-red-800');

                // Left side: Word & Status
                const wordLine = document.createElement('div');
                wordLine.classList.add('flex', 'flex-col');
                wordLine.innerHTML = `
                    <span class="font-bold text-xl">${item.word}</span>
                    <span class="text-sm ${isCorrect ? 'text-green-600' : 'text-red-600'}">
                        ${isCorrect ? 'Correct!' : 'Failed.'} (Tries: ${item.attempts})
                    </span>
                `;
                resultDiv.appendChild(wordLine);

                // Right side: Attempted Word
                const attemptLine = document.createElement('div');
                attemptLine.classList.add('text-right');
                
                const attemptLabel = document.createElement('span');
                attemptLabel.className = `word-result-label px-3 py-1 rounded-full ${isCorrect ? 'bg-green-500 text-white' : 'bg-red-500 text-white'}`;
                attemptLabel.textContent = item.finalRack.length > 0 ? item.finalRack.join(' ').toUpperCase() : 'N/A';
                
                resultDiv.appendChild(attemptLabel);
                resultsBreakdown.appendChild(resultDiv);
            });
        }


        // --- Global Drag Listeners for body/document to handle tile returns ---
        document.addEventListener('dragenter', (e) => e.preventDefault(), false);
        document.addEventListener('dragover', (e) => e.preventDefault(), false);
        document.addEventListener('drop', (e) => {
            const sourceId = e.dataTransfer.getData('sourceId');
            const draggedTile = document.getElementById(sourceId);
            
            if (draggedTile && !e.target.closest('.drop-zone') && e.target.id !== 'tiles-container' && e.target.closest('#tiles-container') === null) {
                // Check if the tile was in a slot before being dropped outside
                const parentSlot = draggedTile.parentNode;
                if (parentSlot && parentSlot.classList.contains('drop-zone')) {
                    const slotIndex = Array.from(slotsContainer.children).indexOf(parentSlot);
                    placedTiles[slotIndex] = null;
                }

                // Append it back to the tiles container
                tilesContainer.appendChild(draggedTile);
                draggedTile.classList.remove('opacity-40');
                
                updateCheckButtonState();
            }
        });

        // Add event listener to the main button (Next Word is now Skip Word)
        document.getElementById('next-button').addEventListener('click', () => {
             // Record as incorrect/skipped before advancing
            totalIncorrect++;
            roundResults.push({
                word: currentWordData.word,
                status: "skipped",
                attempts: 0,
                finalRack: []
            });
            loadNextWord();
        });

        // --- Initialization ---
        window.onload = function() {
            initializeAudio(); 
            setupGame();
        };

    </script>
</body>
</html>
